<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—ªå…‰è®°å¿†çŸ©é˜µ - è®°å¿†åŠ›è®­ç»ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Orbitron', sans-serif;
            overflow: hidden;
            touch-action: manipulation; /* é˜²æ­¢åŒå‡»æ”¾å¤§ */
        }

        .game-container {
            display: grid;
            gap: 12px;
            margin: 0 auto;
            transition: all 0.5s ease;
        }

        .tile {
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid #334155;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.1s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .tile:active {
            transform: scale(0.95);
        }

        /* æ¿€æ´»çŠ¶æ€çš„é¢œè‰²ç±» */
        .tile.active {
            transform: scale(0.95);
            border-color: #fff;
            box-shadow: 0 0 20px currentColor;
        }

        .tile.active::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: currentColor;
            opacity: 0.6;
            animation: pulse 0.3s ease-out;
        }

        @keyframes pulse {
            0% { opacity: 0.8; }
            100% { opacity: 0; }
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* éœ“è™¹è‰²å½©å®šä¹‰ */
        .color-0 { color: #f472b6; } /* Pink */
        .color-1 { color: #22d3ee; } /* Cyan */
        .color-2 { color: #a78bfa; } /* Purple */
        .color-3 { color: #34d399; } /* Emerald */
        .color-4 { color: #fbbf24; } /* Amber */

        .overlay {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center select-none">

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="w-full max-w-md px-4 mb-6 flex justify-between items-center text-sm md:text-base">
        <div class="text-center">
            <p class="text-slate-400 text-xs">åˆ†æ•°</p>
            <p id="score" class="text-2xl font-bold text-cyan-400">0</p>
        </div>
        <div class="text-center">
            <h1 class="text-xl md:text-2xl font-bold tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">è®°å¿†çŸ©é˜µ</h1>
        </div>
        <div class="text-center">
            <p class="text-slate-400 text-xs">æœ€é«˜åˆ†</p>
            <p id="highScore" class="text-xl font-bold text-amber-400">0</p>
        </div>
    </div>

    <!-- ç”Ÿå‘½å€¼ä¸å…³å¡ -->
    <div class="w-full max-w-md px-6 mb-4 flex justify-between items-end">
        <div class="flex space-x-1" id="livesContainer">
            <!-- Hearts will be injected here -->
        </div>
        <div class="text-right">
            <span class="text-slate-400 text-xs uppercase tracking-wider">Level</span>
            <span id="levelDisplay" class="text-xl text-white ml-1">1</span>
        </div>
    </div>

    <!-- æ¸¸æˆä¸»åŒºåŸŸ -->
    <div class="relative w-full max-w-md p-4 flex justify-center">
        <div id="gridContainer" class="game-container">
            <!-- Tiles generated by JS -->
        </div>
        
        <!-- é®ç½©å±‚ï¼šå¼€å§‹/ç»“æŸæ¸¸æˆ -->
        <div id="gameOverlay" class="overlay absolute inset-0 rounded-2xl flex flex-col items-center justify-center z-10 transition-opacity duration-300">
            <div id="startScreen" class="text-center">
                <div class="mb-6 text-6xl">ğŸ§ </div>
                <h2 class="text-2xl font-bold mb-2 text-white">å‡†å¤‡å¥½äº†å—ï¼Ÿ</h2>
                <p class="text-slate-300 mb-8 text-sm px-4">è§‚å¯Ÿé—ªçƒçš„é¡ºåºï¼Œç„¶åæŒ‰æ­£ç¡®çš„é¡ºåºç‚¹å‡»æ–¹å—ã€‚</p>
                <button id="startBtn" class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95 text-lg">
                    å¼€å§‹æŒ‘æˆ˜
                </button>
            </div>

            <div id="gameOverScreen" class="text-center hidden">
                <div class="mb-4 text-6xl">ğŸ’¥</div>
                <h2 class="text-3xl font-bold text-white mb-2">æ¸¸æˆç»“æŸ</h2>
                <p class="text-slate-300 mb-6">æœ€ç»ˆå¾—åˆ†: <span id="finalScore" class="text-cyan-400 text-xl">0</span></p>
                <button id="restartBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-400 hover:to-pink-400 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95 text-lg">
                    å†è¯•ä¸€æ¬¡
                </button>
            </div>
        </div>

        <!-- æ¶ˆæ¯æç¤º -->
        <div id="messageToast" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none opacity-0 transition-opacity duration-200 z-20">
            <span class="text-4xl font-bold text-white drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]" id="toastText"></span>
        </div>
    </div>

    <!-- åº•éƒ¨è¯´æ˜ -->
    <div class="mt-8 text-slate-500 text-xs text-center px-4 max-w-md">
        <p>æç¤ºï¼šéšç€ç­‰çº§æå‡ï¼Œç½‘æ ¼ä¼šå˜å¤§ï¼Œé€Ÿåº¦ä¼šå˜å¿«ã€‚</p>
        <p>æˆ´ä¸Šè€³æœºä½“éªŒæ›´ä½³ ğŸ§</p>
    </div>

    <script>
        // --- æ¸¸æˆé…ç½® ---
        const CONFIG = {
            startGridSize: 3, // 3x3
            maxGridSize: 5,   // 5x5
            baseDelay: 600,   // åˆå§‹é—´éš”(ms)
            minDelay: 250,    // æœ€å¿«é—´éš”
            pointsPerTile: 10
        };

        // --- çŠ¶æ€å˜é‡ ---
        let state = {
            level: 1,
            score: 0,
            lives: 3,
            sequence: [],
            playerIndex: 0,
            gridSize: CONFIG.startGridSize,
            isPlaying: false,
            isInputLocked: true,
            highScore: parseInt(localStorage.getItem('memoryMatrixHighScore')) || 0
        };

        // --- éŸ³é¢‘ç³»ç»Ÿ (Web Audio API) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function initAudio() {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        // ç®€å•çš„åˆæˆå™¨éŸ³æ•ˆ
        function playTone(index, type = 'sine') {
            if (!audioCtx) return;
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            // äº”å£°éŸ³é˜¶é¢‘ç‡è®¡ç®— (Pentatonic scale based)
            // åŸºç¡€é¢‘ç‡ 220Hz (A3), æ ¹æ®indexå˜åŒ–
            const baseFreq = 220;
            const pentatonicSteps = [0, 2, 4, 7, 9]; // åŠéŸ³é˜¶è·¨åº¦
            const octave = Math.floor(index / 5);
            const stepIndex = index % 5;
            const note = baseFreq * Math.pow(2, octave + pentatonicSteps[stepIndex] / 12);

            osc.type = type;
            osc.frequency.setValueAtTime(note, audioCtx.currentTime);
            
            // ç®€å•çš„åŒ…ç»œ
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);

            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.35);
        }

        function playErrorSound() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(110, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(55, audioCtx.currentTime + 0.3);
            
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }

        // --- DOM å…ƒç´  ---
        const gridContainer = document.getElementById('gridContainer');
        const scoreEl = document.getElementById('score');
        const highScoreEl = document.getElementById('highScore');
        const levelEl = document.getElementById('levelDisplay');
        const livesContainer = document.getElementById('livesContainer');
        const overlay = document.getElementById('gameOverlay');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const startBtn = document.getElementById('startBtn');
        const restartBtn = document.getElementById('restartBtn');
        const toastEl = document.getElementById('messageToast');
        const toastText = document.getElementById('toastText');

        // --- æ¸¸æˆé€»è¾‘ ---

        function updateUI() {
            scoreEl.innerText = state.score;
            levelEl.innerText = state.level;
            highScoreEl.innerText = state.highScore;
            
            // æ›´æ–°ç”Ÿå‘½å€¼å¿ƒå½¢
            livesContainer.innerHTML = '';
            for(let i=0; i<3; i++) {
                const heart = document.createElement('span');
                heart.innerText = 'â¤';
                heart.className = i < state.lives ? 'text-red-500 text-xl' : 'text-slate-700 text-xl';
                livesContainer.appendChild(heart);
            }
        }

        function createGrid() {
            gridContainer.innerHTML = '';
            // åŠ¨æ€è®¾ç½® Grid æ ·å¼
            gridContainer.style.gridTemplateColumns = `repeat(${state.gridSize}, 1fr)`;
            
            // è®¡ç®—æ–¹å—å¤§å°ä»¥é€‚åº”å®¹å™¨
            const containerWidth = Math.min(window.innerWidth - 32, 448); // max-w-md = 28rem = 448px
            const gapTotal = (state.gridSize - 1) * 12;
            const tileSize = (containerWidth - gapTotal) / state.gridSize;

            gridContainer.style.width = '100%';

            const totalTiles = state.gridSize * state.gridSize;
            for (let i = 0; i < totalTiles; i++) {
                const tile = document.createElement('div');
                tile.className = `tile color-${i % 5}`;
                tile.style.height = `${tileSize}px`; // ä¿æŒæ­£æ–¹å½¢ (å¤§è‡´)
                tile.dataset.index = i;
                tile.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(i); });
                tile.addEventListener('mousedown', () => handleInput(i));
                gridContainer.appendChild(tile);
            }
        }

        function showToast(msg, colorClass = 'text-white') {
            toastText.innerText = msg;
            toastText.className = `text-4xl font-bold drop-shadow-md ${colorClass}`;
            toastEl.style.opacity = '1';
            toastEl.style.transform = 'translate(-50%, -50%) scale(1.2)';
            setTimeout(() => {
                toastEl.style.opacity = '0';
                toastEl.style.transform = 'translate(-50%, -50%) scale(1)';
            }, 800);
        }

        async function startGame() {
            initAudio();
            state = {
                level: 1,
                score: 0,
                lives: 3,
                sequence: [],
                playerIndex: 0,
                gridSize: CONFIG.startGridSize,
                isPlaying: true,
                isInputLocked: true,
                highScore: state.highScore
            };
            
            overlay.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                startScreen.classList.add('hidden');
                gameOverScreen.classList.add('hidden');
            }, 300);

            updateUI();
            createGrid();
            
            // ç¨ä½œå»¶è¿Ÿå¼€å§‹ç¬¬ä¸€å…³
            setTimeout(nextLevel, 1000);
        }

        async function nextLevel() {
            state.playerIndex = 0;
            state.isInputLocked = true;
            
            // éš¾åº¦é€’å¢é€»è¾‘
            // æ¯3å…³å¢åŠ ç½‘æ ¼å¤§å°ï¼Œç›´åˆ°æœ€å¤§å€¼
            if (state.level > 1 && state.level % 3 === 1 && state.gridSize < CONFIG.maxGridSize) {
                state.gridSize++;
                createGrid();
                showToast("æ‰©å®¹!", "text-purple-400");
                await new Promise(r => setTimeout(r, 1000));
            }

            updateUI();
            
            // æ·»åŠ æ–°çš„ä¸€æ­¥åˆ°åºåˆ—ä¸­
            const totalTiles = state.gridSize * state.gridSize;
            const nextStep = Math.floor(Math.random() * totalTiles);
            state.sequence.push(nextStep);

            // æ’­æ”¾åºåˆ—
            await playSequence();
            
            state.isInputLocked = false;
            showToast("GO!", "text-green-400");
        }

        async function playSequence() {
            const tiles = document.querySelectorAll('.tile');
            
            // è®¡ç®—å½“å‰é€Ÿåº¦ï¼šå…³å¡è¶Šé«˜è¶Šå¿«
            let delay = Math.max(CONFIG.minDelay, CONFIG.baseDelay - (state.level * 30));

            for (let i = 0; i < state.sequence.length; i++) {
                const index = state.sequence[i];
                await new Promise(resolve => setTimeout(resolve, delay));
                
                activateTile(tiles[index], index);
                
                await new Promise(resolve => setTimeout(resolve, delay)); // äº®ç¯æŒç»­æ—¶é—´çš„ä¸€åŠä½œä¸ºé—´éš”
            }
        }

        function activateTile(tile, index) {
            tile.classList.add('active');
            playTone(index);
            setTimeout(() => {
                tile.classList.remove('active');
            }, 300);
        }

        function handleInput(index) {
            if (!state.isPlaying || state.isInputLocked) return;

            const tiles = document.querySelectorAll('.tile');
            const correctIndex = state.sequence[state.playerIndex];

            // è§†è§‰åé¦ˆï¼šç‚¹å‡»é«˜äº®
            activateTile(tiles[index], index);

            if (index === correctIndex) {
                // æ­£ç¡®
                state.playerIndex++;
                
                if (state.playerIndex === state.sequence.length) {
                    // å®Œæˆå½“å‰åºåˆ—
                    state.score += (state.sequence.length * CONFIG.pointsPerTile);
                    state.level++;
                    
                    if (state.score > state.highScore) {
                        state.highScore = state.score;
                        localStorage.setItem('memoryMatrixHighScore', state.highScore);
                    }

                    state.isInputLocked = true;
                    setTimeout(() => {
                        showToast("å®Œç¾!", "text-cyan-400");
                        setTimeout(nextLevel, 1000);
                    }, 500);
                }
            } else {
                // é”™è¯¯
                handleMistake(tiles[index]);
            }
            updateUI();
        }

        function handleMistake(tile) {
            playErrorSound();
            tile.classList.add('shake', 'bg-red-500', 'border-red-500');
            state.lives--;
            state.isInputLocked = true; // æš‚æ—¶é”å®šé˜²æ­¢ä¹±ç‚¹

            showToast("å¤±è¯¯!", "text-red-500");

            setTimeout(() => {
                tile.classList.remove('shake', 'bg-red-500', 'border-red-500');
                
                if (state.lives <= 0) {
                    gameOver();
                } else {
                    // é‡æ–°æ’­æ”¾å½“å‰åºåˆ—è®©ç©å®¶å†æ¬¡å°è¯•
                    state.playerIndex = 0;
                    setTimeout(() => {
                        playSequence().then(() => {
                            state.isInputLocked = false;
                        });
                    }, 1000);
                }
            }, 500);
        }

        function gameOver() {
            state.isPlaying = false;
            document.getElementById('finalScore').innerText = state.score;
            
            overlay.classList.remove('opacity-0', 'pointer-events-none');
            startScreen.classList.add('hidden');
            gameOverScreen.classList.remove('hidden');
        }

        // --- äº‹ä»¶ç›‘å¬ ---
        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', startGame);

        // åˆå§‹åŒ– High Score æ˜¾ç¤º
        highScoreEl.innerText = state.highScore;
        createGrid(); // åˆ›å»ºåˆå§‹èƒŒæ™¯ç½‘æ ¼çœ‹èµ·æ¥å¥½çœ‹ç‚¹

    </script>
</body>
</html>